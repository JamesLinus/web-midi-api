<!DOCTYPE html>
<html>
  <head>
    <title>Web MIDI API</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />

    <style media="all">
      table {border-collapse: collapse; border: 1px solid #000; font: normal 80%/140% arial, helvetica, sans-serif; color: #555; background: #fff;}
      td, th {border: 1px dotted #bbb; padding:.5em 1em; font-size: x-small; width: 10em; }
      caption {padding: 0 0 .5em 0; text-align: left; font-size: 1; font-weight: 500; text-align: center; color: #666; background: transparent;}
      table a {padding: 1px; text-decoration: none; font-weight: bold; background: transparent;}
      table a:link {border-bottom: 1px dashed #ddd; color: #000;}
      table a:visited {border-bottom: 1px dashed #ccc; text-decoration: line-through; color: #808080;}
      table a:hover {border-bottom: 1px dashed #bbb; color: #666;}
      thead th, tfoot th {white-space: nowrap; border: 1px solid #000; text-align: center; color: black; background: #ddd;}
      tfoot td {border: 2px solid #000;}
      tbody { height: 300px; overflow: auto; }
      tbody th {color: #060606; }
      tbody th, tbody td {vertical-align: middle; text-align: center; }
    </style>
    <!-- 
      === NOTA BENE ===
      For the three scripts below, if your spec resides on dev.w3 you can check them
      out in the same tree and use relative links so that they'll work offline,
     -->
    <script src='https://www.w3.org/Tools/respec/respec-w3c-common' class='remove'></script>
    <script class='remove'>
      var respecConfig = {
          specStatus:           "ED",
          copyrightStart: "2012",
          edDraftURI:           "https://dvcs.w3.org/hg/audio/raw-file/tip/midi",
          extraCSS:             ["http://dev.w3.org/2009/dap/ReSpec.js/css/respec.css"],
          editors:  [
              { name: "Jussi Kalliokoski", url: "http://avd.io" },
              { name: "Chris Wilson", url: "mailto:cwilso@google.com",
                company: "Google", companyURL: "http://google.com" },
          ],
          wg:           "Audio Working Group",
          wgURI:        "http://www.w3.org/2011/audio/",
          wgPublicList: "public-audio",
          wgPatentURI:  "http://www.w3.org/2004/01/pp-impl/46884/status",
      };
    </script>    
  </head>
  <body>
    <section id="abstract">
      <p>
        This document introduces an API for accessing and manipulating
        the MIDI devices available on the users' systems.
      </p>
    </section>
    <section class="informative">
      <h2>Introduction</h2>
      <p>
        The Web MIDI API specification defines a means for web developers to
        enumerate, manipulate and access MIDI devices. Having an API for MIDI
        gives a means to make various applications using existing software and
        hardware synths, as well as light systems and other mechanical
        apparatus controlled by MIDI, along with a method of communication with
        existing DAW (Digital Audio Workstation), trackers and other music
        software on the user's computer.
      </p>
    </section>

    <section id="conformance">
      <p>
        This specification defines conformance criteria that apply to a single
        product: the <dfn>user agent</dfn> that implements the
        interfaces that it contains.
      </p>
      <p>
        Implementations that use ECMAScript to implement the APIs defined in
        this specification must implement them in a manner consistent with the
        ECMAScript Bindings defined in the Web IDL specification [[!WEBIDL]],
        as this specification uses that specification and terminology.
      </p>
    </section>

    <section>
      <h2>Terminology</h2>
      <p>
        The <code><a href="http://dev.w3.org/html5/spec/webappapis.html#function">
        Function</a></code> interface represents a function in the scripting
        language being used as defined in [[!HTML5]].
      </p>
      <p>
        The concepts <dfn><a href="http://dev.w3.org/html5/spec/webappapis.html#queue-a-task">
        queue a task</a></dfn> and
        <dfn><a href="http://dev.w3.org/html5/spec/webappapis.html#fire-a-simple-event">
        fires a simple event</a></dfn> are defined in [[!HTML5]].
      </p>
      <p>
        The terms <dfn><a href="http://dev.w3.org/html5/spec/webappapis.html#event-handlers">
        event handlers</a></dfn> and
        <dfn><a href="http://dev.w3.org/html5/spec/webappapis.html#event-handler-event-type">
        event handler event types</a></dfn> are defined in [[!HTML5]].
      </p>
      <p>
        The term <dfn><a href="http://www.khronos.org/registry/typedarray/specs/latest/#7">Uint8Array</a></dfn>
        is defined in [[!TYPED-ARRAYS]].
      </p>
      <p>
        The term <dfn><a href=
        "http://dvcs.w3.org/hg/webperf/raw-file/tip/specs/HighResolutionTime/Overview.html#sec-DOMHighResTimeStamp"
        >DOMHighResTimeStamp</a></dfn> is defined in the <a href=
        "http://dvcs.w3.org/hg/webperf/raw-file/tip/specs/HighResolutionTime/Overview.html"
        >High Resolution Time Specification</a>.
      </p>
<!-- FIXME: This list is not exhaustive. -->
    </section>

    <section>
      <h2>Security and privacy considerations</h2>
      <p>
        Allowing the enumeration of the users MIDI devices and access to the
        information they send is a potential prime target for fingerprinting,
        and possibly eavesdropping. Therefore implementations SHOULD carefully
        follow the <a href="#idl-def-NavigatorMIDIAccess">suggested security model</a>.
      </p>
    </section>

    <section>
      <h2>Obtaining access to user's devices</h2>

      <section>
          <h2><a>NavigatorMIDIAccess</a> Interface</h2>

          <dl class="idl"
              title="[NoInterfaceObject] interface NavigatorMIDIAccess">
            <dt>void getMIDIAccess(NavigatorMIDIAccessSuccessCallback
                                    successCallback,
                                    NavigatorMIDIAccessErrorCallback?
                                    errorCallback)</dt>
            <dd>
              <p>
                Prompts user for permission to use their MIDI Devices.
              </p>

              <p>
                If the user accepts, <var>successCallback</var> is invoked,
                with a <code><a>MIDIAccess</a></code> object as its argument.
              </p>

              <p>
                If the user declines, the <var>errorCallback</var> (if any)
                is invoked.
              </p>

              <p>
                When the <dfn id="dom-navigator-getmidiaccess">
                <code>getMIDIAccess()</code></dfn> method is called, the user
                agent MUST run the following steps:
              </p>

              <ol>
                <li><p>
                  Let <var>successCallback</var> be the callback indicated by
                  the method's first argument.
                </p></li>

                <li><p>
                  Let <var>errorCallback</var> be the callback indicated by
                  the method's second argument, if any, or null otherwise.
                </p></li>

                <li><p>
                  If <var>successCallback</var> is null, abort these steps.
                </p></li>

                <li><p>
                  Return, and run the following steps asynchronously.
                </p></li>

                <li><p>
                  Optionally, e.g. based on a previously-established user
                  preference, for security reasons, or due to platform
                  limitations, jump to the step labeled <em>failure</em>
                  below.
                </p></li>

                <li>
                  <p>
                    Prompt the user in a user-agent-specific manner for
                    permission to provide the entry script's origin with a
                    <code><a>MIDIAccess</a></code> object representing
                    control over user's MIDI devices.
                  </p>

                  <p>
                    If the user denies permission, jump to the step labeled
                    <em>failure</em> below. If the user never responds, this
                    algorithm stalls on this step.
                  </p>
                </li>

                <li><p>
                  Let <var>access</var> be the <code><a
                  >MIDIAccess</a></code> object for which the user granted
                  access.
                </p></li>

                <li><p>
                  Queue a task to invoke <var>successCallback</var> with
                  <var>access</var> as its argument.
                </p></li>

                <li><p>
                  If <var>successCallback</var> is null, abort these steps.
                </p></li>

                <li><p>
                  Abort these steps.
                </p></li>

                <li><p>
                  <em>Failure</em>: If <var>errorCallback</var> is null,
                  abort these steps.
                </p></li>

                <li><p>
                  Let <var>error</var> be a new <code>
                  <a
                    href="#navigatormidiaccesserror">NavigatorMIDIAccessError</a>
                  </code> object whose <code
                    title="dom-NavigatorMIDIAccessError-code">
                  <a href="#dom-navigatormidiaccesserror-code">code</a>
                  </code> attribute has the numeric value 1 (<code
                    title="dom-NavigatorMIDIAccessError-PERMISSION_DENIED">
                  <a
                    href="#dom-navigatormidiaccesserror-permission_denied">PERMISSION_DENIED</a>
                  </code>).
                </p></li>

                <li><p>
                  Queue a task to invoke <var>errorCallback</var> with
                  <var>error</var> as its argument.
                </p></li>

                <li><p>
                  If <var>successCallback</var> is null, abort these steps.
                </p></li>

                <li><p>
                  If <var>successCallback</var> is null, abort these steps.
                </p></li>

                <li><p>
                  If <var>successCallback</var> is null, abort these steps.
                </p></li>
              </ol>

              <p>
                The task source for these <span
                title="concept-task">tasks</span> is the user interaction
                task source.
              </p>
            </dd>
          </dl>

          <div class="idl" title="Navigator implements NavigatorMIDIAccess"></div>
      </section>

      <section>
        <h2>NavigatorMIDIAccessSuccessCallback</h2>

        <dl class="idl"
            title="callback NavigatorMIDIAccessSuccessCallback = void">
          <dt>MIDIAccess access</dt>

          <dd>
            A <code><a>MIDIAccess</a></code> object created to provide
            script access to the user's MIDI devices.
          </dd>
        </dl>
      </section>

      <section>
        <h2>
          NavigatorMIDIAccessError and
          NavigatorMIDIAccessErrorCallback
        </h2>

        <dl class="idl"
            title="[NoInterfaceObject] interface NavigatorMIDIAccessError">
          <dt>const unsigned short PERMISSION_DENIED = 1</dt>

          <dd>
            The user denied the page permission to use the user's MIDI
            devices.
          </dd>

          <dt>readonly attribute unsigned short code</dt>

          <dd>
            Returns the current error's error code. At this time, this will
            always be 1, for which the constant <code
              title="dom-NavigatorMIDIAccessError-PERMISSION_DENIED">
              <a
              href="#dom-navigatormidiaccesserror-permission_denied">PERMISSION_DENIED</a>
            </code> is defined.
          </dd>
        </dl>

        <dl class="idl"
            title="callback NavigatorMIDIAccessErrorCallback = void">
          <dt>NavigatorMIDIAccessError error</dt>

          <dd>
            A <code><a>NavigatorMIDIAccessError</a></code> object representing
            an explanation of why access to the user's MIDI devices was not
            granted.
          </dd>
        </dl>
      </section>
    </section>

    <section>
      <h2><a>MIDIAccess</a> Interface</h2>
      <dl title="[NoInterfaceObject]
                 interface MIDIAccess"
          class="idl">
        <dt>sequence&lt;MIDIPort&gt; enumerateInputs()</dt>
        <dd>
          Returns a list of the MIDI input ports available on the system.
<!-- TODO: Specify the steps the UA is required to take. -->
        </dd>
        <dt>sequence&lt;MIDIPort&gt; enumerateOutputs()</dt>
        <dd>
          Returns a list of the MIDI output ports available on the system.
<!-- TODO: Specify the steps the UA is required to take. -->
        </dd>
        <dt><a>MIDIInput</a> getInput(MIDIPort or DOMString target)</dt>
        <dd>
          Acquires access to the input <code><a>MIDIPort</a></code> requested
          as a <code><a>MIDIInput</a></code> instance. 

          <p>
            When the
            <dfn id="midiaccess-get-input"><code>getInput()</code></dfn>
            is invoked, the user agent MUST run the following steps:
          </p>

          <ol>
            <li>
              <p>Let <var>target</var> be the
              <code><a>MIDIPort</a></code> argument.
              If the <var>target</var> is a DOMString,
              <var>target</var> will be a <code><a>MIDIPort</a></code>
              whose <code>fingerprint</code> matches the supplied
              DOMString.
            </li>

            <li>
              <p>
                If <var>target</var> is not a <code><a>MIDIPort</a></code>
                instance, or if the MIDIPort is not a valid MIDI input
                port, throw a <code>TYPE_ERROR</code> exception.
              </p>
            </li>

            <li>
              <p>
                If <var>target</var> is not available for access, throw a
                <code>REFERENCE_ERROR</code> exception.
              </p>
            </li>

            <li>
              <p>
                If made necessary by the underlying system APIs, reserve
                the corresponding port for use within the current process.
              </p>
            </li>

            <li>
              <p>
                Return a <code>MIDIInput</code> corresponding the
                <var>target</var> argument.
              </p>
            </li>
          </ol>
        </dd>
        <dt><a>MIDIOutput</a> getOutput(MIDIPort or DOMString target)</dt>
        <dd>
          Acquires access to the output <code><a>MIDIPort</a></code> requested
          as a <code><a>MIDIOutput</a></code> instance. 

          <p>
            When the
            <dfn id="midiaccess-get-output"><code>getOutput()</code></dfn>
            is invoked, the user agent MUST run the following steps:
          </p>

          <ol>
            <li>
              <p>Let <var>target</var> be the
              <code><a>MIDIPort</a></code> argument.
              If the <var>target</var> is a DOMString,
              <var>target</var> will be a <code><a>MIDIPort</a></code>
              whose <code>fingerprint</code> matches the supplied
              DOMString.
            </li>

            <li>
              <p>
                If <var>target</var> is not a <code><a>MIDIPort</a></code>
                instance, or if the MIDIPort is not a valid MIDI output
                port, throw a <code>TYPE_ERROR</code> exception.
              </p>
            </li>

            <li>
              <p>
                If <var>target</var> is not available for access, throw a
                <code>REFERENCE_ERROR</code> exception.
              </p>
            </li>

            <li>
              <p>
                If made necessary by the underlying system APIs, reserve
                the corresponding port for use within the current process.
              </p>
            </li>

            <li>
              <p>
                Return a <code>MIDIOutput</code> corresponding the
                <var>target</var> argument.
              </p>
            </li>
          </ol>
        </dd>
      </dl>
    </section>

    <section>
      <h2><a>MIDIPort</a> Interface</h2>

      <p id="event-midiport-disconnect">
        Whenever the MIDI port corresponding the
        <code><a>MIDIPort</a></code> is disconnected or becomes unavailable,
        the UA SHOULD run the following steps:
      </p>

      <ol>
        <li>
          <p>
            Fire a simple event named <code><a
            href="#event-midiport-disconnect">disconnect</a></code>
            at the object.
          </p>
        </li>
      </ol>

      <p id="event-midiport-connect">
        Whenever the MIDI port corresponding the
        <code><a>MIDIPort</a></code> is connected or reconnected,
        the UA MUST run the following steps:
      </p>

      <ol>
        <li>
          <p>
            Fire a simple event named <code><a
            href="#event-midiport-connect">connect</a></code>
            at the object.
          </p>
        </li>
      </ol>

      <dl class="idl" title='enum MIDIPortType'>
        <dt>"input"</dt>
        <dd>
          If a MIDIPort is an input port, this MUST be this value.
        </dd>
        <dt>"output"</dt>
        <dd>
          If a MIDIPort is an output port, this MUST be this value.
        </dd>
      </dl>

      <div class="idl" title="MIDIInput implements MIDIPort"></div>
      <div class="idl" title="MIDIOutput implements MIDIPort"></div>
      <dl title="[NoInterfaceObject]
                 interface MIDIPort : EventTarget"
          class="idl">
        <dt>readonly attribute MIDIPortType type</dt>
        <dd>
          <p>
            A descriptor property to distinguish whether the port is an
            input or an output port.
            For <code><a>MIDIOutput</a></code>,
            this MUST be <code>"output"</code>.
            For <code><a>MIDIInput</a></code>,
            this MUST be <code>"input"</code>.
          </p>
        </dd>
        <dt>readonly attribute DOMString name</dt>
        <dd>
          <p>The system name of the port.</p>
        </dd>
        <dt>readonly attribute DOMString manufacturer</dt>
        <dd>
          <p>The manufacturer of the port.</p>
        </dd>
        <dt>readonly attribute DOMString version</dt>
        <dd>
          <p>The version of the port.</p>
        </dd>
        <dt>readonly attribute DOMString fingerprint</dt>
        <dd>
          <p>
            A unique ID of the port. This can be used by developers to
            remember ports the user has chosen for different applications.
            The User Agent SHOULD make sure the
            <code><a>fingerprint</a></code>
            is unique to only that port if possible.
          </p>
        </dd>
        <dt class="no-docs">[TreatNonCallableAsNull] attribute
                            Function? ondisconnect</dt>
        <dd>
            <p>
              This event handler, of type <code><a href=
              "#event-midiport-disconnect">disconnect</a></code>,
              SHOULD be supported by all objects implementing the
              <code><a>MIDIPort</a></code> interface.
            </p>
        </dd>
        <dt class="no-docs">[TreatNonCallableAsNull] attribute
                            Function? onconnect</dt>
        <dd>
            <p>
              This event handler, of type <code><a href=
              "#event-midiport-connect">connect</a></code>,
              SHOULD be supported by all objects implementing the
              <code><a>MIDIPort</a></code> interface.
            </p>
        </dd>
      </dl>

      <div class="note">
        <p>
          The <code><a>disconnect</a></code> and
          <code><a>connect</a></code> events may not be applicable to all
          MIDI ports or OS APIs. For example, an actual  MIDI port does not
          support the notion of disconnect and connect while a USB MIDI Device
          may be plugged in or out on the fly. Therefore the semantics here is
          SHOULD, rather than MUST.
        </p>
      </div>

      <section>
        <h3><a>MIDIInput</a> Interface</h3>

        <p id="event-midiinput-message">
          Whenever the MIDI port corresponding the
          <code><a>MIDIInput</a></code> sends a MIDI message, the UA MUST
          run the following steps:
        </p>

        <ol>
          <li>
            <p>
              Let <code>port</code> be the <code><a>MIDIInput</a></code>.
            </p>
          </li>

          <li>
            <p>
              Let <code>messages</code> be a newly constructed
              <code>sequence&lt;<a>MIDIMessage</a>&gt;</code> corresponding the
              MIDI messages the port sent.
            </p>
          </li>

          <li>
            <p>
              Let <code>event</code> be a newly constructed
              <code><a>MIDIEvent</a></code>, with the <code>MIDIMessages</code>
              attribute set to <code>messages</code>.
            </p>
          </li>

          <li>
            <p>
              Fire an event named <code><a
              href="#event-midiinput-message">message</a></code>
              at the object, using the <code>event</code> as the event object.
            </p>
          </li>
        </ol>

        <dl title="[NoInterfaceObject]
                   interface MIDIInput implements EventTarget"
            class="idl">
          <dt class="no-docs">[TreatNonCallableAsNull] attribute
                              Function? onmessage</dt>
          <dd>
            <p>
              This event handler, of type <code><a href=
              "#event-midiinput-message">message</a></code>,
              MUST be supported by all objects implementing
              <code><a>MIDIInput</a></code> interface.
            </p>
          </dd>
        </dl>
      </section>

      <section>
        <h3><a>MIDIOutput</a> Interface</h3>
        <dl title="[NoInterfaceObject]
                   interface MIDIOutput"
            class="idl">
          <dt>void sendMIDIMessage(MIDIMessage message)</dt>
          <dd>
            <p>
              Enqueues the message to be send to the corresponding MIDI port.
            </p>
          </dd>
          <dt>void sendMessage(short status, short... data)</dt>
          <dd>
            <p>
              Creates a new MIDI message of the given arguments and enqueues it
              to be sent to the corresponding MIDI port.
            </p>
          </dd>
        </dl>
      </section>
    </section>

    <section>
      <h2><a>MIDIMessage</a> Interface</h2>
      <dl title="[NoInterfaceObject]
                 dictionary MIDIMessage"
          class="idl">
        <dt>DOMHighResTimeStamp timestamp</dt>
        <dd>
          <p>
            A <code>DOMHighResTimeStamp</code> signifying when the event
            occured, will occur or should occur.
          </p>
        </dd>
        <dt>Uint8Array data</dt>
        <dd>
          <p>
            A Uint8Array signifying the data the message contains.
          </p>
        </dd>
      </dl>

      <section>
        <h3><a>MIDIEvent</a> Interface</h3>
        
        <dl title="[NoInterfaceObject]
                   interface MIDIEvent : Event"
            class="idl">
          <dt>readonly attribute <a>MIDIMessage</a>[] MIDIMessages</dt>
          <dd>
            <p>
              An array of <code><a>MIDIMessage</a></code>s associated
              with the event.
            </p>
          </dd>
        </dl>
      </section>
    </section>
  </body>
</html>
